"use strict";(self.webpackChunksavannah_bites=self.webpackChunksavannah_bites||[]).push([[20],{4020:(e,s,r)=>{r.r(s),r.d(s,{default:()=>x});var a=r(5043),t=r(6213),n=r(3393),i=r(9677),c=r(3216),o=r(5169),l=r(1991),d=r(579);const m=(0,i.c)("pk_test_51PyXSWGcnCWhaKLpaYfGJQ4c765ub8sv5vsP47SNgMeP98sQ0cW6BUyoVmlluP8xseHpSiUKbbnVIKkmkRbDokU300r1DgKy4Z"),p="http://10.77.228.19:5000/api",u=t.A.create({baseURL:p.endsWith("/api")?p:`${p}/api`,withCredentials:!0,headers:{"Content-Type":"application/json"}}),h=2.5;function v(){var e,s;const r=(0,n.useStripe)(),t=(0,n.useElements)(),i=(0,c.Zp)(),m=(0,c.zy)(),{cart:p,clearCart:v}=(0,o._)(),[x,j]=(0,a.useState)(!1),[y,g]=(0,a.useState)(null),f=null===(e=m.state)||void 0===e?void 0:e.orderDetails;(0,a.useEffect)((()=>{null!==f&&void 0!==f&&f.customerInfo&&p.length||(console.log("Missing order details or empty cart, redirecting to checkout"),i("/checkout"))}),[f,p,i]);const N=()=>{const e=p.reduce(((e,s)=>e+(s.selectedPrice||s.price)*s.quantity),0);return{subtotal:e,deliveryFee:h,total:e+h}},{subtotal:b,total:I}=N();return(0,d.jsxs)("div",{className:"payment-container",children:[(0,d.jsx)(l.A,{currentStep:2}),(0,d.jsxs)("div",{className:"payment-header",children:[(0,d.jsx)("h1",{children:"Secure Payment"}),(0,d.jsxs)("div",{className:"order-summary",children:[(0,d.jsx)("h2",{children:"Order Summary"}),(0,d.jsx)("div",{className:"items-list",children:p.map((e=>(0,d.jsxs)("div",{className:"order-item",children:[(0,d.jsxs)("div",{className:"item-info",children:[(0,d.jsx)("span",{className:"item-name",children:e.name}),e.size&&(0,d.jsx)("span",{className:"item-size",children:e.size})]}),(0,d.jsxs)("div",{className:"item-price",children:[(0,d.jsxs)("span",{className:"quantity",children:["x",e.quantity]}),(0,d.jsxs)("span",{className:"price",children:["\xa3",((e.selectedPrice||e.price)*e.quantity).toFixed(2)]})]})]},`${e.id||e._id}-${e.size||"regular"}`)))}),(0,d.jsxs)("div",{className:"price-breakdown",children:[(0,d.jsxs)("div",{className:"price-row",children:[(0,d.jsx)("span",{children:"Subtotal"}),(0,d.jsxs)("span",{children:["\xa3",b.toFixed(2)]})]}),(0,d.jsxs)("div",{className:"price-row",children:[(0,d.jsx)("span",{children:"Delivery Fee"}),(0,d.jsxs)("span",{children:["\xa3",h.toFixed(2)]})]}),(0,d.jsxs)("div",{className:"price-row total",children:[(0,d.jsx)("span",{children:"Total to Pay"}),(0,d.jsxs)("span",{children:["\xa3",I.toFixed(2)]})]})]})]}),(0,d.jsxs)("div",{className:"delivery-info",children:[(0,d.jsx)("h3",{children:"Delivery Details"}),(null===f||void 0===f?void 0:f.customerInfo)&&Object.entries(f.customerInfo).map((e=>{let[s,r]=e;return"email"!==s&&"specialInstructions"!==s&&(0,d.jsxs)("div",{className:"info-row",children:[(0,d.jsxs)("span",{children:[s.charAt(0).toUpperCase()+s.slice(1).replace(/([A-Z])/g," $1"),":"]}),(0,d.jsx)("span",{children:r})]},s)})),(null===f||void 0===f||null===(s=f.customerInfo)||void 0===s?void 0:s.specialInstructions)&&(0,d.jsxs)("div",{className:"special-instructions",children:[(0,d.jsx)("h4",{children:"Special Instructions:"}),(0,d.jsx)("p",{children:f.customerInfo.specialInstructions})]})]})]}),(0,d.jsxs)("form",{onSubmit:async e=>{if(e.preventDefault(),r&&t&&!x)try{j(!0),g(null),console.log("Submitting payment form...");const{error:e}=await t.submit();if(e)throw e;console.log("Confirming payment...");const{error:s,paymentIntent:a}=await r.confirmPayment({elements:t,confirmParams:{return_url:`${window.location.origin}/confirmation`,payment_method_data:{billing_details:{name:f.customerInfo.name,email:f.customerInfo.email,phone:f.customerInfo.phone,address:{line1:f.customerInfo.address,city:f.customerInfo.city,postal_code:f.customerInfo.postcode,country:"GB"}}}},redirect:"if_required"});if(s)throw console.error("Payment error:",s),s;if("succeeded"===a.status){console.log("Payment succeeded, creating order...");const{orderId:e}=await(async e=>{try{console.log("Creating order...");const{subtotal:s,deliveryFee:r,total:a}=N(),t={paymentIntentId:e.id,orderDetails:{items:p.map((e=>({id:e._id||e.id,name:e.name,quantity:e.quantity,price:e.selectedPrice||e.price,size:e.size||"regular"}))),subtotal:s,deliveryFee:r,totalAmount:a,customerInfo:f.customerInfo}};console.log("Sending order data:",t);const n=await u.post("/orders",t);return console.log("Order created successfully:",n.data),n.data}catch(y){var s,r,a,t;throw console.error("Order creation failed:",y),console.error("Error details:",{message:y.message,response:null===(s=y.response)||void 0===s?void 0:s.data,status:null===(r=y.response)||void 0===r?void 0:r.status}),new Error("Failed to create order: "+((null===(a=y.response)||void 0===a||null===(t=a.data)||void 0===t?void 0:t.message)||y.message))}})(a);v(),i("/confirmation",{state:{orderId:e,status:"success",paymentIntentId:a.id},replace:!0})}}catch(y){console.error("Payment/Order error:",y),g(y.message)}finally{j(!1)}},className:"payment-form",children:[(0,d.jsx)("div",{className:"payment-element-container",children:(0,d.jsx)(n.PaymentElement,{})}),y&&(0,d.jsx)("div",{className:"error-message",role:"alert",children:y}),(0,d.jsx)("button",{type:"submit",className:"payment-button",disabled:!r||x,children:(0,d.jsx)("div",{className:"button-content",children:x?(0,d.jsxs)(d.Fragment,{children:[(0,d.jsx)("div",{className:"spinner",role:"status","aria-label":"Processing payment"}),(0,d.jsx)("span",{children:"Processing..."})]}):(0,d.jsxs)("span",{children:["Pay \xa3",I.toFixed(2)]})})})]}),(0,d.jsx)("div",{className:"security-info",children:(0,d.jsx)("p",{children:"\ud83d\udd12 All payments are secure and encrypted"})})]})}const x=function(){var e;const[s,r]=(0,a.useState)(""),[t,i]=(0,a.useState)(null),l=(0,c.zy)(),p=(0,c.Zp)(),{cart:h}=(0,o._)(),x=null===(e=l.state)||void 0===e?void 0:e.orderDetails;return(0,a.useEffect)((()=>{if(!x||null===h||void 0===h||!h.length)return console.log("Invalid payment page access, redirecting to checkout"),void p("/checkout");(async()=>{try{console.log("Creating payment intent..."),console.log("API URL:",u.defaults.baseURL);const e=await u.post("/orders/create-payment-intent",{amount:x.totalAmount,currency:"gbp",metadata:{customerName:x.customerInfo.name,customerEmail:x.customerInfo.email}});console.log("Payment intent created:",e.data),r(e.data.clientSecret)}catch(t){var e,s,a,n;console.error("Payment setup error:",t),console.error("Error details:",{message:t.message,response:null===(e=t.response)||void 0===e?void 0:e.data,status:null===(s=t.response)||void 0===s?void 0:s.status,config:t.config}),i((null===(a=t.response)||void 0===a||null===(n=a.data)||void 0===n?void 0:n.message)||"Failed to setup payment. Please try again.")}})()}),[h,x,p]),t?(0,d.jsxs)("div",{className:"error-container",role:"alert",children:[(0,d.jsx)("h2",{children:"Payment Setup Failed"}),(0,d.jsx)("p",{children:t}),(0,d.jsx)("button",{onClick:()=>p("/checkout"),className:"return-button",children:"Return to Checkout"})]}):s?(0,d.jsx)("div",{className:"payment-page",children:(0,d.jsx)(n.Elements,{stripe:m,options:{clientSecret:s,appearance:{theme:"stripe",variables:{colorPrimary:"#0a5c66",colorBackground:"#ffffff",colorText:"#30313d"}}},children:(0,d.jsx)(v,{})})}):(0,d.jsxs)("div",{className:"loading-container",role:"status",children:[(0,d.jsx)("div",{className:"spinner"}),(0,d.jsx)("p",{children:"Setting up payment..."})]})}},1991:(e,s,r)=>{r.d(s,{A:()=>t});r(5043);var a=r(579);const t=e=>{let{currentStep:s}=e;return(0,a.jsxs)("div",{className:"progress-steps",children:[(0,a.jsxs)("div",{className:"progress-step-wrapper",children:[(0,a.jsxs)("div",{className:"progress-step-container",children:[(0,a.jsx)("div",{className:"progress-step-circle "+(s>=1?"active":""),children:"1"}),(0,a.jsx)("div",{className:"progress-line "+(s>=2?"active":"")})]}),(0,a.jsx)("span",{className:"progress-step-label",children:"Order Details"})]}),(0,a.jsxs)("div",{className:"progress-step-wrapper",children:[(0,a.jsxs)("div",{className:"progress-step-container",children:[(0,a.jsx)("div",{className:"progress-step-circle "+(s>=2?"active":""),children:"2"}),(0,a.jsx)("div",{className:"progress-line "+(s>=3?"active":"")})]}),(0,a.jsx)("span",{className:"progress-step-label",children:"Payment"})]}),(0,a.jsxs)("div",{className:"progress-step-wrapper",children:[(0,a.jsx)("div",{className:"progress-step-container",children:(0,a.jsx)("div",{className:"progress-step-circle "+(s>=3?"active":""),children:"3"})}),(0,a.jsx)("span",{className:"progress-step-label",children:"Confirmation"})]})]})}}}]);
//# sourceMappingURL=20.5788d353.chunk.js.map